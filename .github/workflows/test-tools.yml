# ==============================================================================
# * TOOL INSTALLATION TESTS
# ? Tests ALL optional tool installations and installation profiles.
# ==============================================================================

name: Tool Installation Tests

on:
  push:
    branches: [main, master]
    paths: ['install.sh']
  pull_request:
    branches: [main, master]
    paths: ['install.sh']
  workflow_dispatch:

concurrency:
  group: tools-${{ github.ref }}
  cancel-in-progress: true

env:
  TERM: xterm-256color
  ZSH_DISABLE_COMPFIX: 'true'

jobs:
  # ─────────────────────────────────────────────────────────
  # TOOL MATRIX (7 tools x 2 platforms = 14 jobs)
  # ─────────────────────────────────────────────────────────
  tool-matrix:
    name: ${{ matrix.tool }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        tool: [fzf, eza, bat, ripgrep, fd, zoxide, starship]
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y zsh curl

      - name: Base install
        run: ./install.sh --yes --minimal --skip-tools

      - name: Install ${{ matrix.tool }}
        run: ./install.sh --yes --tools ${{ matrix.tool }}

      - name: Verify ${{ matrix.tool }} installed
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          source ~/.zshenv 2>/dev/null || true
          # Handle tool name mappings (Ubuntu uses different names)
          TOOL="${{ matrix.tool }}"
          [[ "$TOOL" == "ripgrep" ]] && TOOL="rg"
          # Try both names for tools with Ubuntu aliases
          if [[ "$TOOL" == "bat" ]]; then
            command -v bat || command -v batcat || exit 1
          elif [[ "$TOOL" == "fd" ]]; then
            command -v fd || command -v fdfind || exit 1
          else
            command -v "$TOOL" || exit 1
          fi

      - name: Verify ${{ matrix.tool }} runs
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          source ~/.zshenv 2>/dev/null || true
          TOOL="${{ matrix.tool }}"
          [[ "$TOOL" == "ripgrep" ]] && TOOL="rg"
          # Handle Ubuntu binary name aliases
          if [[ "$TOOL" == "bat" ]] && ! command -v bat &>/dev/null; then
            TOOL="batcat"
          elif [[ "$TOOL" == "fd" ]] && ! command -v fd &>/dev/null; then
            TOOL="fdfind"
          fi
          "$TOOL" --version || "$TOOL" --help || true

  # ─────────────────────────────────────────────────────────
  # INSTALLATION PROFILES
  # ─────────────────────────────────────────────────────────
  profiles:
    name: Profile - ${{ matrix.profile }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        profile: [minimal, full]
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Install with --${{ matrix.profile }}
        run: ./install.sh --yes --${{ matrix.profile }} --skip-tools

      - name: Verify installation
        run: ./install.sh --check

      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # TOOL BUNDLE TEST
  # ─────────────────────────────────────────────────────────
  tool-bundle:
    name: All Tools Bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Base install
        run: ./install.sh --yes --minimal --skip-tools

      - name: Install all tools at once
        run: ./install.sh --yes --tools fzf,eza,bat,fd,zoxide

      - name: Verify all tools
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          source ~/.zshenv 2>/dev/null || true
          echo "Checking installed tools..."
          check_tool() {
            local tool="$1"
            # Handle Ubuntu binary name aliases
            if [[ "$tool" == "bat" ]]; then
              command -v bat &>/dev/null || command -v batcat &>/dev/null
            elif [[ "$tool" == "fd" ]]; then
              command -v fd &>/dev/null || command -v fdfind &>/dev/null
            else
              command -v "$tool" &>/dev/null
            fi
          }
          for tool in fzf eza bat fd zoxide; do
            if check_tool "$tool"; then
              echo "  ✓ $tool"
            else
              echo "  ✗ $tool NOT FOUND"
              exit 1
            fi
          done
