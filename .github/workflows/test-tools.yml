# ==============================================================================
# TOOL INSTALLATION TESTS
# Tests ALL optional tool installations and installation profiles.
# ==============================================================================

name: Tool Installation Tests

on:
  push:
    branches: [main]
    paths: ['install.sh', 'tests/**']
  pull_request:
    branches: [main]
    paths: ['install.sh', 'tests/**']
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: tools-${{ github.ref }}
  cancel-in-progress: true

env:
  TERM: xterm-256color
  ZSH_DISABLE_COMPFIX: 'true'

jobs:
  # ─────────────────────────────────────────────────────────
  # TOOL MATRIX (7 tools x 2 platforms = 14 jobs)
  # ─────────────────────────────────────────────────────────
  tool-matrix:
    name: ${{ matrix.tool }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        tool: [fzf, eza, bat, ripgrep, fd, zoxide, starship]
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y zsh curl

      - name: Base install
        run: ./install.sh --yes --minimal --skip-tools

      - name: Install ${{ matrix.tool }}
        run: ./install.sh --yes --tools ${{ matrix.tool }}

      - name: Verify ${{ matrix.tool }} installed
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          # Handle tool name mappings
          TOOL="${{ matrix.tool }}"
          [[ "$TOOL" == "ripgrep" ]] && TOOL="rg"
          # Try both names for tools with Ubuntu aliases
          if [[ "$TOOL" == "bat" ]]; then
            command -v bat || command -v batcat || exit 1
          elif [[ "$TOOL" == "fd" ]]; then
            command -v fd || command -v fdfind || exit 1
          else
            command -v "$TOOL" || exit 1
          fi

      - name: Verify ${{ matrix.tool }} runs
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          TOOL="${{ matrix.tool }}"
          [[ "$TOOL" == "ripgrep" ]] && TOOL="rg"
          # Handle Ubuntu binary name aliases
          if [[ "$TOOL" == "bat" ]] && ! command -v bat &>/dev/null; then
            TOOL="batcat"
          elif [[ "$TOOL" == "fd" ]] && ! command -v fd &>/dev/null; then
            TOOL="fdfind"
          fi
          "$TOOL" --version || "$TOOL" --help || true

  # ─────────────────────────────────────────────────────────
  # INSTALLATION PROFILES
  # ─────────────────────────────────────────────────────────
  profiles:
    name: Profile - ${{ matrix.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        profile: [minimal, full]
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Install with --${{ matrix.profile }}
        run: ./install.sh --yes --${{ matrix.profile }} --skip-tools

      - name: Verify installation
        run: ./install.sh --check

      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # TOOL BUNDLE TEST
  # ─────────────────────────────────────────────────────────
  tool-bundle:
    name: All Tools Bundle
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Base install
        run: ./install.sh --yes --minimal --skip-tools

      - name: Install all tools at once
        run: ./install.sh --yes --tools fzf,eza,bat,fd,zoxide

      - name: Verify all tools
        run: |
          # Source Homebrew on macOS (ARM64 or Intel)
          eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
          echo "Checking installed tools..."
          check_tool() {
            local tool="$1"
            # Handle Ubuntu binary name aliases
            if [[ "$tool" == "bat" ]]; then
              command -v bat &>/dev/null || command -v batcat &>/dev/null
            elif [[ "$tool" == "fd" ]]; then
              command -v fd &>/dev/null || command -v fdfind &>/dev/null
            else
              command -v "$tool" &>/dev/null
            fi
          }
          for tool in fzf eza bat fd zoxide; do
            if check_tool "$tool"; then
              echo "  ✓ $tool"
            else
              echo "  ✗ $tool NOT FOUND"
              exit 1
            fi
          done

  # ─────────────────────────────────────────────────────────
  # TOOL REINSTALL (Idempotency)
  # ─────────────────────────────────────────────────────────
  tool-reinstall:
    name: Tool Reinstall
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Base install
        run: ./install.sh --yes --minimal --skip-tools

      - name: Install fzf first time
        run: ./install.sh --yes --tools fzf

      - name: Get fzf version
        id: first
        run: echo "version=$(fzf --version 2>/dev/null | head -1)" >> $GITHUB_OUTPUT

      - name: Install fzf again (should be idempotent)
        run: ./install.sh --yes --tools fzf

      - name: Verify fzf still works
        run: |
          fzf --version
          echo "Reinstall successful"

  # ─────────────────────────────────────────────────────────
  # NETWORK RESILIENCE
  # ─────────────────────────────────────────────────────────
  network-resilience:
    name: Network Resilience
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Test offline base install
        run: |
          # Base install should work offline (no downloads needed)
          ./install.sh --yes --minimal --skip-tools
          echo "Offline base install OK"

      - name: Verify config works without network
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c 'source ~/.zshenv && echo "Offline config works"'

      - name: Test graceful tool failure
        run: |
          # Block github.com (tool downloads will fail)
          # Note: iptables may not be available in container, use timeout instead
          timeout 10 ./install.sh --yes --tools nonexistent-tool-xyz 2>&1 || true
          echo "Graceful failure on bad tool name"

      - name: Verify config still works after failed tool install
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c 'source ~/.zshenv && echo "Config still works after tool failure"'

  # ─────────────────────────────────────────────────────────
  # UPGRADE SCENARIO (v1 → v2)
  # ─────────────────────────────────────────────────────────
  upgrade-scenario:
    name: Upgrade Scenario
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl

      - name: Simulate "old" installation
        run: |
          # Create an older-style installation
          mkdir -p ~/.config/zsh
          mkdir -p ~/.local/share/zsh
          mkdir -p ~/.cache/zsh

          # Old .zshenv without new features
          cat > ~/.zshenv << 'OLD'
          export ZDOTDIR="$HOME/.config/zsh"
          OLD

          # Old .zshrc with minimal content
          cat > ~/.config/zsh/.zshrc << 'OLD'
          # Old zshrc
          echo "old config loaded"
          OLD

          # Mark as "version 1"
          echo "1.0.0" > ~/.config/zsh/.version

      - name: Run upgrade (current installer)
        run: ./install.sh --yes --minimal --skip-tools

      - name: Verify upgrade preserved user data
        run: |
          # Check backup was created
          ls -la ~/.zsh-backup-* 2>/dev/null || echo "No backup (symlink used)"

      - name: Verify new config works
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

      - name: Verify new features available
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          # Check new modules exist
          [[ -f "$ZDOTDIR/modules/lazy.zsh" ]] || { echo "Missing lazy module"; exit 1; }
          [[ -f "$ZDOTDIR/lib/utils/index.zsh" ]] || { echo "Missing utils"; exit 1; }
          echo "Upgrade successful - new features available"

  # ─────────────────────────────────────────────────────────
  # TOOL DETECTION (pre-installed tools)
  # ─────────────────────────────────────────────────────────
  tool-detection:
    name: Pre-installed Tool Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Install ZSH and some tools manually
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh git curl
          # Install bat and fd via apt (different binary names)
          sudo apt-get install -y bat fd-find

      - name: Run installer (should detect existing tools)
        run: ./install.sh --yes --minimal --skip-tools

      - name: Verify shell detects pre-installed tools
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c '
            source ~/.zshenv
            # Check if bat/batcat is available
            if command -v batcat &>/dev/null; then
              echo "✓ bat detected (as batcat)"
            elif command -v bat &>/dev/null; then
              echo "✓ bat detected"
            fi
            # Check if fd/fdfind is available
            if command -v fdfind &>/dev/null; then
              echo "✓ fd detected (as fdfind)"
            elif command -v fd &>/dev/null; then
              echo "✓ fd detected"
            fi
          '
