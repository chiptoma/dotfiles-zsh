# ==============================================================================
# * PLATFORM TESTS
# ? Tests installation across all supported platforms and distributions.
# ==============================================================================

name: Platform Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: platforms-${{ github.ref }}
  cancel-in-progress: true

env:
  TERM: xterm-256color
  ZSH_DISABLE_COMPFIX: 'true'

jobs:
  # ─────────────────────────────────────────────────────────
  # NATIVE RUNNERS
  # ─────────────────────────────────────────────────────────
  ubuntu:
    name: Ubuntu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  macos:
    name: macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # CONTAINER-BASED PLATFORMS
  # ─────────────────────────────────────────────────────────
  fedora:
    name: Fedora
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install dependencies
        run: dnf install -y git zsh curl findutils
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  arch:
    name: Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - name: Install dependencies
        run: pacman -Sy --noconfirm git zsh curl
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  debian:
    name: Debian
    runs-on: ubuntu-latest
    container: debian:stable
    steps:
      - name: Install dependencies
        run: apt-get update && apt-get install -y git zsh curl ca-certificates
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  alpine:
    name: Alpine
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install dependencies
        run: apk add --no-cache bash git zsh curl coreutils
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: |
          zsh -c 'source ~/.zshenv && echo "Alpine ZDOTDIR: $ZDOTDIR"'

  rocky:
    name: Rocky Linux (RHEL)
    runs-on: ubuntu-latest
    container: rockylinux:9
    steps:
      - name: Install dependencies
        run: dnf install -y --allowerasing git zsh curl
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  wsl-simulation:
    name: WSL (Simulated)
    runs-on: ubuntu-latest
    env:
      WSL_DISTRO_NAME: Ubuntu
      WSL_INTEROP: /run/WSL
    steps:
      - uses: actions/checkout@v4
      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools 2>&1 | tee install.log
      - name: Verify WSL detected
        run: grep -qi "wsl" install.log || echo "WSL environment set up"
      - name: Verify installation
        run: ./install.sh --check

  # ─────────────────────────────────────────────────────────
  # macOS ARM64 vs Intel
  # ─────────────────────────────────────────────────────────
  macos-homebrew:
    name: macOS Homebrew Integration
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect architecture
        run: |
          echo "Architecture: $(uname -m)"
          if [[ "$(uname -m)" == "arm64" ]]; then
            echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
          else
            echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
          fi

      - name: Verify Homebrew available
        run: |
          eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
          brew --version

      - name: Install with full profile
        run: ./install.sh --yes --full --skip-tools

      - name: Verify Homebrew PATH in shell
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c '
            source ~/.zshenv
            echo "PATH includes brew: $(echo $PATH | grep -o homebrew || echo "Intel path")"
            echo "HOMEBREW_PREFIX=$HOMEBREW_PREFIX"
          '

      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # UBUNTU WITH FULL OMZ
  # ─────────────────────────────────────────────────────────
  ubuntu-full:
    name: Ubuntu Full (with OMZ)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl
      - name: Full install
        run: ./install.sh --yes --full --skip-tools
      - name: Verify OMZ
        run: |
          [[ -d ~/.local/share/oh-my-zsh ]] || { echo "OMZ not installed"; exit 1; }
          [[ -f ~/.local/share/oh-my-zsh/oh-my-zsh.sh ]] || { echo "OMZ main file missing"; exit 1; }
      - name: Verify shell loads OMZ
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c 'source ~/.zshenv && source $ZDOTDIR/.zshrc && echo "OMZ loaded: $ZSH"'
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # OLD UBUNTU LTS
  # ─────────────────────────────────────────────────────────
  ubuntu-20:
    name: Ubuntu 20.04 LTS
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - name: Install ZSH
        run: sudo apt-get update && sudo apt-get install -y zsh git curl
      - name: Show ZSH version
        run: zsh --version
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # OPENSUSE
  # ─────────────────────────────────────────────────────────
  opensuse:
    name: openSUSE
    runs-on: ubuntu-latest
    container: opensuse/leap:latest
    steps:
      - name: Install dependencies
        run: zypper install -y git zsh curl tar gzip
      - uses: actions/checkout@v4
      - name: Run installer
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify installation
        run: ./install.sh --check
      - name: Run smoke tests
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh tests/smoke-test.zsh

  # ─────────────────────────────────────────────────────────
  # MINIMAL CONTAINER (No git pre-installed)
  # ─────────────────────────────────────────────────────────
  minimal-container:
    name: Minimal Container
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - name: Install only essentials
        run: |
          apt-get update
          apt-get install -y zsh curl ca-certificates git
      - uses: actions/checkout@v4
      - name: Run minimal install
        run: ./install.sh --yes --minimal --skip-tools
      - name: Verify core functionality
        run: |
          export ZDOTDIR="${HOME}/.config/zsh"
          zsh -c 'source ~/.zshenv && echo "Minimal install works"'
