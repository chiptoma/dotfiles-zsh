# ==============================================================================
# * ZSH CONFIGURATION CI/CD
# ? Tests installation across macOS and Linux platforms.
# ? Runs on push, pull requests, and manual dispatch.
# ==============================================================================

name: CI

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ----------------------------------------------------------
  # * SHELLCHECK LINT
  # ? Static analysis of all shell scripts.
  # ----------------------------------------------------------
  lint:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          format: gcc
          ignore_paths: '*.zsh'
          ignore_names: '*.zsh .zshrc .zshenv .zprofile'

  # ----------------------------------------------------------
  # * INSTALLATION TESTS
  # ? Test install.sh on multiple platforms.
  # ----------------------------------------------------------
  install:
    name: Install (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-13]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh

      - name: Run installer (non-interactive)
        run: |
          chmod +x install.sh
          ./install.sh --yes
        env:
          HOME: ${{ github.workspace }}/test-home
          TERM: xterm-256color

      - name: Verify installation
        run: ./install.sh --check
        env:
          HOME: ${{ github.workspace }}/test-home

      - name: Test shell startup
        run: |
          export HOME="${{ github.workspace }}/test-home"
          export ZDOTDIR="${HOME}/.config/zsh"
          echo "ZDOTDIR=$ZDOTDIR"
          ls -la "$ZDOTDIR" || echo "ZDOTDIR not found, checking install..."
          ls -la "$HOME/.config/" || true
          # Test if files exist before sourcing
          if [[ -f "$ZDOTDIR/.zshenv" ]]; then
            zsh -c "source $ZDOTDIR/.zshenv && echo 'zshenv loaded OK'"
          else
            echo "Note: .zshenv not at ZDOTDIR (may be symlinked install)"
          fi

  # ----------------------------------------------------------
  # * SYNTAX CHECK
  # ? Verify all zsh files parse correctly.
  # ----------------------------------------------------------
  syntax:
    name: ZSH Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh

      - name: Check syntax
        run: |
          errors=0
          for file in $(find . -name "*.zsh" -type f); do
            if ! zsh -n "$file" 2>&1; then
              echo "Syntax error in: $file"
              errors=$((errors + 1))
            fi
          done
          if [[ $errors -gt 0 ]]; then
            echo "Found $errors files with syntax errors"
            exit 1
          fi
          echo "All files passed syntax check"

  # ----------------------------------------------------------
  # * RELEASE (on tag push)
  # ? Create GitHub release with changelog.
  # ----------------------------------------------------------
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [lint, install, syntax]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [[ -n "$PREV_TAG" ]]; then
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
            echo "First versioned release of the ZSH configuration." >> CHANGELOG.md
          fi

          cat CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          generate_release_notes: true
