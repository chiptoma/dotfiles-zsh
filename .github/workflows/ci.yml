# ==============================================================================
# * ZSH CONFIGURATION CI/CD
# ? Tests installation and shell functionality across platforms.
# ==============================================================================

name: CI

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  TERM: xterm-256color
  ZSH_DISABLE_COMPFIX: 'true'

jobs:
  # ----------------------------------------------------------
  # * STATIC ANALYSIS
  # ----------------------------------------------------------
  lint:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          format: gcc
          ignore_paths: '*.zsh'
          ignore_names: '*.zsh .zshrc .zshenv .zprofile'

  syntax:
    name: ZSH Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh
      - name: Check all ZSH files
        run: |
          errors=0
          for file in $(find . -name "*.zsh" -type f) .zshrc .zshenv .zprofile; do
            [[ -f "$file" ]] || continue
            if zsh -n "$file" 2>&1; then
              echo "✓ $file"
            else
              echo "✗ $file"
              errors=$((errors + 1))
            fi
          done
          [[ $errors -eq 0 ]] || exit 1

  # ----------------------------------------------------------
  # * PLATFORM TESTS
  # ----------------------------------------------------------
  test-ubuntu:
    name: Test (Ubuntu)
    runs-on: ubuntu-latest
    env:
      TEST_HOME: ${{ github.workspace }}/test-home
    steps:
      - uses: actions/checkout@v4
      - name: Install zsh
        run: sudo apt-get update && sudo apt-get install -y zsh
      - name: Install configuration
        run: ./install.sh --yes
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Install OMZ plugins
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_DATA_HOME="${HOME}/.local/share"
          ZSH_CUSTOM="${XDG_DATA_HOME}/oh-my-zsh/custom"
          mkdir -p "$ZSH_CUSTOM/plugins"
          git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
          git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
          git clone --depth=1 https://github.com/Aloxaf/fzf-tab "$ZSH_CUSTOM/plugins/fzf-tab"
      - name: Verify installation
        run: ./install.sh --check
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Run smoke tests
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          export ZDOTDIR="${XDG_CONFIG_HOME}/zsh"
          zsh ./scripts/smoke-test.zsh --verbose

  test-macos:
    name: Test (macOS)
    runs-on: macos-latest
    env:
      TEST_HOME: ${{ github.workspace }}/test-home
    steps:
      - uses: actions/checkout@v4
      - name: Install configuration
        run: ./install.sh --yes
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Install OMZ plugins
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_DATA_HOME="${HOME}/.local/share"
          ZSH_CUSTOM="${XDG_DATA_HOME}/oh-my-zsh/custom"
          mkdir -p "$ZSH_CUSTOM/plugins"
          git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
          git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
          git clone --depth=1 https://github.com/Aloxaf/fzf-tab "$ZSH_CUSTOM/plugins/fzf-tab"
      - name: Verify installation
        run: ./install.sh --check
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Run smoke tests
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          export ZDOTDIR="${XDG_CONFIG_HOME}/zsh"
          zsh ./scripts/smoke-test.zsh --verbose

  test-fedora:
    name: Test (Fedora)
    runs-on: ubuntu-latest
    container: fedora:latest
    env:
      TEST_HOME: /tmp/test-home
    steps:
      - name: Install dependencies
        run: dnf install -y git zsh findutils
      - uses: actions/checkout@v4
      - name: Install configuration
        run: ./install.sh --yes
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Install OMZ plugins
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_DATA_HOME="${HOME}/.local/share"
          ZSH_CUSTOM="${XDG_DATA_HOME}/oh-my-zsh/custom"
          mkdir -p "$ZSH_CUSTOM/plugins"
          git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
          git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
          git clone --depth=1 https://github.com/Aloxaf/fzf-tab "$ZSH_CUSTOM/plugins/fzf-tab"
      - name: Verify installation
        run: ./install.sh --check
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Run smoke tests
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          export ZDOTDIR="${XDG_CONFIG_HOME}/zsh"
          zsh ./scripts/smoke-test.zsh --verbose

  test-arch:
    name: Test (Arch)
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      TEST_HOME: /tmp/test-home
    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm git zsh
      - uses: actions/checkout@v4
      - name: Install configuration
        run: ./install.sh --yes
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Install OMZ plugins
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_DATA_HOME="${HOME}/.local/share"
          ZSH_CUSTOM="${XDG_DATA_HOME}/oh-my-zsh/custom"
          mkdir -p "$ZSH_CUSTOM/plugins"
          git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
          git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
          git clone --depth=1 https://github.com/Aloxaf/fzf-tab "$ZSH_CUSTOM/plugins/fzf-tab"
      - name: Verify installation
        run: ./install.sh --check
        env:
          HOME: ${{ env.TEST_HOME }}
          XDG_CONFIG_HOME: ${{ env.TEST_HOME }}/.config
      - name: Run smoke tests
        run: |
          export HOME="${{ env.TEST_HOME }}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          export ZDOTDIR="${XDG_CONFIG_HOME}/zsh"
          zsh ./scripts/smoke-test.zsh --verbose

  # ----------------------------------------------------------
  # * RELEASE
  # ----------------------------------------------------------
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [lint, syntax, test-ubuntu, test-macos, test-fedora, test-arch]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$PREV_TAG" ]]; then
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            git log --pretty=format:"- %s" "$PREV_TAG"..HEAD >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
          fi
      - uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          generate_release_notes: true
